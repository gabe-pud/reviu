{% extends 'base.html' %}
{% load static %}

{% block title %}Revisar Cards - Reviu{% endblock %}

{% block body %}
<div class="h-screen flex flex-col">
  <div class="min-h-screen bg-white flex flex-col items-center justify-center p-4 relative overflow-hidden">
      <!-- Botão Voltar para o Deck no topo à direita -->
      <div class="w-full max-w-2xl flex justify-end mb-2 z-30 relative">
          <a href="{% url 'decks' %}" class="px-6 py-2 bg-[#003554] text-white rounded-full font-semibold shadow hover:bg-[#045685] transition-colors">
              Voltar para o Deck
          </a>
      </div>
      {% if card %}

      <!-- Card de Revisão com Flip -->
      <div class="w-full max-w-2xl mb-8 h-96" style="perspective: 1000px;">
          <div id="review-card" class="relative w-full h-full transition-transform duration-500 cursor-pointer" style="transform-style: preserve-3d;">
              
              <!-- Frente do Card (Pergunta) -->
              <div class="card-front absolute w-full h-full bg-linear-to-b from-[#FE9A09] to-[#FF8000] rounded-3xl shadow-xl p-8 flex flex-col justify-center items-center" style="backface-visibility: hidden;">
                  <p class="text-2xl text-[#003554] font-bold text-center" id="card-question">
                      {{ card.frontText }}
                  </p>
                  <p class="text-center text-[#003554] mt-6 opacity-75 text-sm">
                      Clique para ver a resposta
                  </p>
              </div>
              
              <!-- Verso do Card (Resposta) -->
              <div class="card-back absolute w-full h-full bg-linear-to-b from-[#003554] to-[#002a42] rounded-3xl shadow-xl p-8 flex flex-col justify-center items-center" style="backface-visibility: hidden; transform: rotateY(180deg);">
                  <p class="text-3xl text-white font-bold text-center mb-4" id="card-answer">
                      {{ card.backText }}
                  </p>
                  <p class="text-center text-white opacity-75 text-sm">
                      Avalie sua resposta abaixo
                  </p>
              </div>
              
          </div>
      </div>
      {% else %}
      <div class="bg-white rounded-2xl shadow-lg p-8 text-center">
        <h2 class="text-xl font-bold text-[#003554] mb-3">Sem cartas para revisar</h2>
        <p class="text-gray-600 mb-6">Parabéns — não há cartas pendentes para este baralho agora.</p>
        <a href="{% url 'decks' %}" class="inline-block px-6 py-3 bg-[#003554] text-white rounded-full">Voltar para decks</a>
      </div>
      {% endif %}
      <!-- Botões de Avaliação Embaixo -->
      <div id="rating-buttons" class="hidden">
        <form method="post" class="w-full max-w-2xl grid grid-cols-5 gap-2 md:gap-4 mb-8 z-40">
            {% csrf_token %}
            <input type="hidden" name="card_id" value="{{ card.id }}" />
            <input type="hidden" name="deck_id" value="{{ deck_id }}" />
            <button type="button"
                onclick="rateCard(5)"
                class="px-2 py-2 md:px-6 md:py-4 bg-red-600 text-white font-bold rounded-xl hover:bg-red-700 transition-colors">
                <div class="text-xs mb-1">Errei</div>
            </button>
            <button type="button"
                onclick="rateCard(4)"
                class="px-2 py-2 md:px-6 md:py-4 bg-orange-500 text-white font-bold rounded-xl hover:bg-orange-600 transition-colors">
                <div class="text-xs mb-1">Difícil</div>
            </button>
            <button type="button"
                onclick="rateCard(3)"
                class="px-2 py-2 md:px-6 md:py-4 bg-yellow-400 text-[#003554] font-bold rounded-xl hover:bg-yellow-500 transition-colors">
                <div class="text-xs mb-1">Normal</div>
            </button>
            <button type="button"
                onclick="rateCard(2)"
                class="px-2 py-2 md:px-6 md:py-4 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700 transition-colors">
                <div class="text-xs mb-1">Fácil</div>
            </button>
            <button type="button"
                onclick="rateCard(1)"
                class="px-2 py-2 md:px-6 md:py-4 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 transition-colors">
                <div class="text-xs mb-1">Muito fácil</div>
            </button>
        </form>
      </div>
      
      <div class="h-16 md:h-0"></div>
      <!-- Botão Voltar para o Deck removido do rodapé -->
      
  </div>
</div>
{% endblock %}

{% block extra_body %}
<script>
    const reviewCard = document.getElementById('review-card');
    const ratingButtons = document.getElementById('rating-buttons');
    let isFlipped = false;

    // URL do endpoint de review (view `card_review`)
    const reviewUrl = "{% url 'card_review' deck_id=deck_id %}";

    // Flip ao clicar no card
    if (reviewCard) {
      reviewCard.addEventListener('click', function() {
          if (!isFlipped) {
              reviewCard.style.transform = 'rotateY(180deg)';
              isFlipped = true;
              ratingButtons.classList.remove('hidden');
          } else {
              reviewCard.style.transform = 'rotateY(0deg)';
              isFlipped = false;
              ratingButtons.classList.add('hidden');
          }
      });
    }

    async function rateCard(rating) {
        try {
            console.log('Card avaliado como:', rating);
            const form = document.querySelector('#rating-buttons form');
            if (!form) return;

            const csrfInput = form.querySelector('input[name="csrfmiddlewaretoken"]');
            const csrf = csrfInput ? csrfInput.value : '';
            const cardIdInput = form.querySelector('input[name="card_id"]');
            const cardId = cardIdInput ? cardIdInput.value : '';
            const deckIdInput = form.querySelector('input[name="deck_id"]');
            const deckId = deckIdInput ? deckIdInput.value : '';

            // Disable buttons to avoid double submissions
            const btns = Array.from(form.querySelectorAll('button'));
            btns.forEach(b => b.disabled = true);

            const body = new URLSearchParams();
            body.append('card_id', cardId);
            // enviar 'quality' conforme formato aceito pelo endpoint
            body.append('quality', rating);
            body.append('deck_id', deckId);

            const res = await fetch(reviewUrl, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrf,
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: body.toString(),
                credentials: 'same-origin'
            });

            if (!res.ok && res.status !== 302 && res.status !== 0) {
                throw new Error('Resposta não OK: ' + res.status);
            }

            // Após enviar o review, recarregar a página para buscar o próximo card
            window.location.reload();

        } catch (err) {
            console.error('Erro ao enviar avaliação', err);
            const form = document.querySelector('#rating-buttons form');
            if (form) Array.from(form.querySelectorAll('button')).forEach(b => b.disabled = false);
            alert('Erro ao enviar avaliação. Tente novamente.');
        } finally {
            // reset visual local (a reload geralmente irá atualizar tudo de qualquer forma)
            if (reviewCard) reviewCard.style.transform = 'rotateY(0deg)';
            isFlipped = false;
            ratingButtons.classList.add('hidden');
        }
    }

    (function(){
    const front = document.getElementById('card-front');
    const back = document.getElementById('card-back');
    if (!front || !back) return;
    back.style.display = 'none';
    front.addEventListener('click', () => {
      front.style.display = 'none'; back.style.display = '';
    });
    back.addEventListener('click', () => {
      back.style.display = 'none'; front.style.display = '';
    });
  })();
</script>
{% endblock %}