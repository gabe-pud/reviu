{% load static %}

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% endblock title %}</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Poppins:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'src/output.css' %}">

</head>
<body>
    <div class="h-screen flex">
        {% if page == "auth" %}
        {% else %}
            <nav id="main-nav" class="absolute flex justify-between px-16 pb-4 w-full bottom-0 bg-[#003554]
            md:static md:left-0 md:bottom-auto md:flex-col md:pr-4 md:pl-2 md:py-16 md:w-fit md:justify-start md:gap-5">
                <img id="nav-bg" class="absolute left-9 -top-[33.5px] w-28 pointer-events-none transition-all duration-300 ease-in-out z-10
                md:rotate-90 md:left-4.75 md:top-13.5" src="{% static 'resouces/nav-button-bg.svg' %}" alt="">

                <a href="#" class="nav-btn size-14 p-3 rounded-full transition-transform duration-300 ease-in-out z-30 -translate-y-[29px] md:translate-y-0 md:translate-x-11" role="button" aria-current="page">
                    <img src="{% static 'resouces/home.svg' %}" alt="Home">
                </a>
                <a href="#" class="nav-btn size-14 p-3 rounded-full transition-transform duration-300 ease-in-out z-30" role="button">
                    <img src="{% static 'resouces/cards.svg' %}" alt="Cards">
                </a>
                {% comment %} utilizando botão de perfil como logout por enquanto, alterar assim que pagina de perfil estiver disponível {% endcomment %}
                <a href="{% url 'logout' %}" class="nav-btn size-14 p-3 rounded-full transition-transform duration-300 ease-in-out z-30" role="button">
                    <img src="{% static 'resouces/user.svg' %}" alt="User">
                </a>
            </nav>
        {% endif %}
        <div class="grow overflow-scroll scrollbar-hidden">
        {% block body %}
        {% endblock body %}
        </div>    
    </div>

    {% block extra_body %}
    {% endblock extra_body %}

    {% if page == "auth" %}
    {% else %}
        <script>
            (function(){
                const nav = document.getElementById('main-nav');
                const bg = document.getElementById('nav-bg');
                const buttons = Array.from(nav.querySelectorAll('.nav-btn'));

                // media query para md (>= 48rem / 768px)
                const mql = window.matchMedia('(min-width: 48rem)');

                function moveBgTo(btn) {
                    const navRect = nav.getBoundingClientRect();
                    const btnRect = btn.getBoundingClientRect();

                    if (mql.matches) {
                        // Desktop / md+: mover verticalmente (top)
                        const top = btnRect.top - navRect.top + (btnRect.height / 2) - (bg.offsetHeight / 2);
                        bg.style.top = Math.max(-9999, top) + 'px';
                        // limpar left para evitar conflitos
                        bg.style.left = '';
                    } else {
                        // Mobile: mover horizontalmente (left)
                        const left = btnRect.left - navRect.left + (btnRect.width / 2) - (bg.offsetWidth / 2);
                        bg.style.left = Math.max(0, left) + 'px';
                        bg.style.top = '';
                    }

                    // atualizar estado ativo via classes Tailwind responsivas
                    buttons.forEach(b => {
                        b.classList.remove('-translate-y-[29px]');
                        b.classList.remove('md:translate-x-11');
                    });

                    if (mql.matches) {
                        btn.classList.add('md:translate-x-11');
                    } else {
                        btn.classList.add('-translate-y-[29px]');
                    }
                }

                // Adicionar listeners
                buttons.forEach(btn => {
                    btn.addEventListener('click', function(e){
                        const isAnchor = btn.tagName === 'A';
                        const href = isAnchor ? btn.getAttribute('href') : null;

                        // só previne a navegação para href vazios/# (comportamento de botão)
                        const shouldPrevent = href === '#' || href === '' || href === null;

                        if (shouldPrevent) {
                            if (e && typeof e.preventDefault === 'function') e.preventDefault();
                            moveBgTo(btn);
                            return;
                        }

                        // Para links reais: prevenir a navegação nativa, animar e navegar após a transição
                        if (e && typeof e.preventDefault === 'function') e.preventDefault();
                        moveBgTo(btn);

                        let navigated = false;
                        function navigate() {
                            if (navigated) return;
                            navigated = true;
                            window.location.href = href;
                        }

                        function onTransitionEnd(ev) {
                            // garantir que seja o bg que terminou a transição
                            if (ev.target === bg) {
                                cleanup();
                                navigate();
                            }
                        }

                        function cleanup() {
                            bg.removeEventListener('transitionend', onTransitionEnd);
                            clearTimeout(timeoutId);
                        }

                        bg.addEventListener('transitionend', onTransitionEnd);
                        // fallback caso transitionend não dispare (duracao do CSS é 300ms)
                        const timeoutId = setTimeout(() => { cleanup(); navigate(); }, 600);
                    });

                    // suporte a teclado: Enter / Space -> disparar o clique (mesmo fluxo)
                    btn.addEventListener('keydown', function(e){
                        if (e.key === 'Enter' || e.key === ' ') {
                                e.preventDefault();
                                // dispara o handler de click programaticamente
                                btn.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true }));
                        }
                    });
                });

                // Reposicionar ao redimensionar e quando a media query mudar
                function repositionActive() {
                    const active = buttons.find(b => b.classList.contains('-translate-y-[29px]') || b.classList.contains('md:translate-x-11')) || buttons[0];
                    if (active) moveBgTo(active);
                }

                window.addEventListener('resize', repositionActive);
                if (typeof mql.addEventListener === 'function') {
                    mql.addEventListener('change', repositionActive);
                } else if (typeof mql.addListener === 'function') {
                    mql.addListener(repositionActive);
                }

                // Inicializar: posicionar atrás do primeiro botão (ou do ativo se houver)
                window.addEventListener('load', function(){
                    repositionActive();
                });
            })();
        </script>
    {% endif %}
</body>
</html>